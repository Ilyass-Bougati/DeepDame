<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>DeepDame | Chat Administration</title>
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            display: block;
            background-color: var(--bg-cream);
            margin: 0;
        }
        .chat-container { max-width: 1000px; margin: 20px auto; }

        #chat-window {
            height: 650px; overflow-y: auto; background: white;
            border-radius: 15px; padding: 25px; border: 1px solid var(--sage-light);
            display: flex; flex-direction: column;
        }

        .message-card {
            border-left: 4px solid var(--sage-primary); margin-bottom: 15px;
            padding: 15px; background: #fff; border-radius: 4px 12px 12px 4px;
            transition: all 0.3s ease;
        }

        .btn-sage { background-color: var(--sage-primary); color: white; border: none; }
        .btn-clay { background-color: var(--dusty-clay); color: white; border: none; }

        .admin-actions { opacity: 0; transition: opacity 0.3s; }
        .message-card:hover .admin-actions { opacity: 1; }

        #status-badge { transition: all 0.3s ease; }
    </style>
</head>
<body>

<div th:replace="~{admin/fragments/header :: adminHeader}"></div>

<div class="container chat-container">
    <div class="card border-0 shadow-sm" style="border-radius: 20px;">
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-0" style="color: var(--sage-dark); font-weight: bold;">LIVE MODERATION</h5>
                <small class="text-muted">Real-time supervision of the general chat</small>
            </div>
            <div id="status-badge" class="badge rounded-pill px-3 py-2"
                 style="background-color: #dee2e6; color: #6c757d;">Connecting...</div>
        </div>

        <div id="chat-window" class="card-body">
            <div th:each="msg : ${messages}" th:id="'message-' + ${msg.id}" class="message-card">
                <div class="d-flex justify-content-between align-items-start">
                    <div style="flex: 1;">
                        <div class="mb-1">
                            <span class="fw-bold" style="color: var(--sage-primary);" th:text="${msg.user.username}">User</span>
                            <small class="text-muted ms-2" th:text="${#temporals.format(msg.createdAt, 'HH:mm')}">12:00</small>
                        </div>
                        <p class="mb-0 text-dark" th:text="${msg.message}">Message content...</p>
                    </div>

                    <div th:if="${@userSecurity.canManage(msg.user.id, #authentication.principal)}"
                         class="admin-actions ms-3 text-end" style="min-width: 120px;">

                        <button type="button"
                                th:data-id="${msg.id}"
                                data-type="chat"
                                onclick="handleBan(this)"
                                class="btn btn-sm btn-sage mb-1 w-100">Ban Chat</button>

                        <button type="button"
                                th:data-id="${msg.id}"
                                data-type="app"
                                onclick="handleBan(this)"
                                class="btn btn-sm btn-clay w-100">Ban App</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="moderationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 15px;">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" style="color: var(--sage-dark);">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body py-4">
                <p id="modalMessage" class="mb-0 text-muted">Are you sure you want to proceed?</p>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirmBanBtn" class="btn btn-clay rounded-pill px-4">Confirm Ban</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
    let stompClient = null;
    let moderationModal = null;
    let pendingMessageId = null;
    let pendingBanType = null;

    document.addEventListener('DOMContentLoaded', function() {

        moderationModal = new bootstrap.Modal(document.getElementById('moderationModal'));

        document.getElementById('confirmBanBtn').addEventListener('click', executeBanAction);

        connect();
    });

    function connect() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.debug = null;

        stompClient.connect({}, function (frame) {
            updateStatus(true);

            stompClient.subscribe('/topic/general-chat', function (response) {
                appendMessage(JSON.parse(response.body));
            });

            stompClient.subscribe('/topic/general-chat-delete', function (response) {
                const deletedId = response.body.replace(/"/g, '');
                const el = document.getElementById('message-' + deletedId);
                if (el) {
                    el.classList.add('fade-out');
                    setTimeout(() => el.remove(), 500);
                }
            });
        }, function(error) {
            console.error("STOMP Error:", error);
            updateStatus(false);
            setTimeout(connect, 5000);
        });
    }

    function updateStatus(connected) {
        const badge = document.getElementById('status-badge');
        if (!badge) return;
        if (connected) {
            badge.style.backgroundColor = "#2d6a4f";
            badge.innerText = "Live: Connected";
        } else {
            badge.style.backgroundColor = "#bc4749";
            badge.style.color = "white";
            badge.innerText = "Disconnected - Retrying...";
        }
    }

    function appendMessage(msg) {
        const chatWindow = document.getElementById('chat-window');
        if (!chatWindow) return;

        const messageDiv = document.createElement('div');
        messageDiv.className = 'message-card';
        messageDiv.id = `message-${msg.id}`;
        messageDiv.setAttribute('data-message-id', msg.id);

        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        messageDiv.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
            <div style="flex: 1;">
                <div class="mb-1">
                    <span class="fw-bold user-name-label" style="color: #6a994e;"></span>
                    <small class="text-muted ms-2">${time}</small>
                </div>
                <p class="mb-0 text-dark user-message-content"></p>
            </div>
            <div class="admin-actions ms-3 text-end" style="min-width: 120px;">
                <button class="btn btn-sm btn-sage mb-1 w-100 btn-ban-chat">Ban Chat</button>
                <button class="btn btn-sm btn-clay w-100 btn-ban-app">Ban App</button>
            </div>
        </div>
    `;

        messageDiv.querySelector('.user-name-label').textContent = msg.user.username;
        messageDiv.querySelector('.user-message-content').textContent = msg.message;

        messageDiv.querySelector('.btn-ban-chat').addEventListener('click', () => {
            showModerationModal(msg.id, 'chat');
        });
        messageDiv.querySelector('.btn-ban-app').addEventListener('click', () => {
            showModerationModal(msg.id, 'app');
        });

        chatWindow.appendChild(messageDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function handleBan(button) {
        const id = button.getAttribute('data-id');
        const type = button.getAttribute('data-type');
        showModerationModal(id, type);
    }

    function showModerationModal(messageId, type) {
        pendingMessageId = messageId;
        pendingBanType = type;

        const scopeText = type === 'chat' ? 'from the general chat' : 'from the entire application';
        document.getElementById('modalMessage').innerText = `Are you sure you want to ban this user ${scopeText}?`;

        moderationModal.show();
    }

    function executeBanAction() {
        if (!pendingMessageId || !pendingBanType) return;

        fetch(`/admin/chat/ban-user-from-${pendingBanType}/${pendingMessageId}`, {
            method: 'POST'
        }).then(res => {
            if (res.status === 403) {
                alert("Action Denied: You do not have the hierarchical rights.");
            }
            moderationModal.hide();
        }).catch(err => {
            console.error("Fetch error:", err);
            moderationModal.hide();
        });
    }
</script>
</body>
</html>