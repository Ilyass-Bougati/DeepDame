<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management | DeepDame</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link th:href="@{/css/admin.css}" rel="stylesheet">

    <style>
        .deepdame-container { width: 100%; max-width: 1300px; margin: 0 auto; }
        .table-card {
            background: white;
            border-radius: 12px;
            border: 1px solid rgba(0,0,0,0.05);
            overflow: hidden;
        }

        /* Row Interactivity */
        tbody tr {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        tbody tr:hover {
            background-color: rgba(115, 147, 126, 0.05) !important;
        }

        .icon-verified { color: var(--soft-gold); }
        .badge-role {
            background-color: var(--bg-cream);
            color: var(--sage-dark);
            border: 1px solid var(--sage-light);
        }

        body { display: block; }
    </style>
</head>
<body>

<div th:replace="~{admin/fragments/header :: adminHeader}"></div>

<main class="deepdame-container px-4">
    <div class="mb-4">
        <div th:if="${success}" class="alert alert-success alert-dismissible fade show border-0 shadow-sm mb-4" role="alert" style="border-radius: 12px;">
            <strong th:text="${success}"></strong>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show border-0 shadow-sm mb-4" role="alert" style="border-radius: 12px;">
            <strong th:text="${error}"></strong>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <h2 style="font-family: 'Georgia', serif; color: var(--sage-dark); font-weight: bold;">User Management</h2>
        <p class="text-muted">Review and manage DeepDame member accounts.</p>
    </div>

    <div class="table-card shadow-sm">
        <div class="table-responsive">
            <div class="row justify-content-center mb-5">
                <div class="col-md-8 col-lg-6">
                    <form th:action="@{/admin/users}" method="get">
                        <div class="input-group shadow-sm" style="border-radius: 12px; overflow: hidden; border: 1px solid #dee2e6;">
                            <input type="text"
                                   name="keyword"
                                   th:value="${keyword}"
                                   class="form-control border-0 py-3 ps-4"
                                   placeholder="Search by name or email..."
                                   style="background-color: #ffffff;">

                            <button class="btn px-4 fw-bold"
                                    type="submit"
                                    style="background-color: var(--sage-primary); color: white; border-radius: 0;">
                                SEARCH
                            </button>

                            <a th:if="${keyword}"
                               th:href="@{/admin/users}"
                               class="btn btn-light d-flex align-items-center border-start px-3"
                               style="color: #666;">
                                CLEAR
                            </a>
                        </div>
                    </form>
                </div>
            </div>
            <table class="table mb-0 align-middle">
                <thead style="background-color: var(--bg-cream);">
                <tr>
                    <th class="py-3 px-4">User</th>
                    <th>Email</th>
                    <th>Validated</th>
                    <th>Roles</th>
                    <th>Status</th>
                    <th class="text-center px-4">Actions</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="user : ${users}"
                    th:data-url="@{/admin/users/details/{id}(id=${user.id})}"
                    th:data-manageable="${@userSecurity.canManage(user, #authentication.principal)}"
                    onclick="if(this.getAttribute('data-manageable') === 'true') window.location.href=this.getAttribute('data-url');"
                    th:style="${@userSecurity.canManage(user, #authentication.principal)} ? 'cursor: pointer;' : 'cursor: not-allowed; opacity: 0.6;'">

                    <td class="px-4">
                        <span class="fw-bold" th:text="${user.username}">Username</span>
                    </td>
                    <td>
                        <span th:text="${user.email}">email@gmail.com</span>
                    </td>
                    <td>
                        <span th:if="${user.emailValidated}" class="icon-verified ms-1" title="Verified">Verified</span>
                    </td>
                    <td>
                        <span th:each="role : ${user.roles}" class="badge badge-role me-1" th:text="${role.name}">ROLE</span>
                    </td>
                    <td>
                        <span th:if="${user.bannedFromApp}" class="badge rounded-pill" style="background-color: var(--dusty-clay);">BANNED</span>
                        <span th:unless="${user.bannedFromApp}" class="badge rounded-pill" style="background-color: var(--sage-primary);">ACTIVE</span>
                    </td>

                    <td class="px-4" onclick="event.stopPropagation();">
                        <div class="d-flex justify-content-center gap-2" th:if="${@userSecurity.canManage(user, #authentication.principal)}">
                            <a th:href="@{/admin/users/edit/{id}(id=${user.id})}" class="btn btn-sm btn-outline-primary">Edit</a>

                            <button type="button"
                                    class="btn btn-sm btn-outline-danger"
                                    data-bs-toggle="modal"
                                    data-bs-target="#deleteModal"
                                    th:data-bs-id="${user.id}"
                                    th:data-bs-username="${user.username}">
                                Delete
                            </button>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</main>
<div th:replace="~{admin/fragments/modals :: deleteUserModal}"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>