<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DeepDame Smart Debugger v2.2</title>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    <style>
        body { font-family: 'Consolas', 'Segoe UI', monospace; padding: 20px; background: #1e1e1e; color: #c0c0c0; margin: 0; height: 100vh; display: flex; flex-direction: column; }

        /* --- LAYOUT GRID --- */
        .container { display: flex; gap: 20px; flex: 1; min-height: 0; }

        /* Left Column: Controls */
        .controls { width: 320px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }

        /* Middle Column: Board + Chat */
        .center-column { width: 380px; display: flex; flex-direction: column; gap: 15px; }

        /* Right Column: Logs */
        .logs-panel { flex: 1; background: #111; border: 1px solid #333; display: flex; flex-direction: column; border-radius: 5px; }

        /* --- COMPONENT STYLING --- */

        /* Boxes */
        .box { background: #2d2d2d; border: 1px solid #444; padding: 15px; border-radius: 5px; }
        h2 { border-bottom: 2px solid #007bff; padding-bottom: 5px; margin-top: 0; font-size: 1.2rem; color: #fff; }
        h3 { margin: 0 0 10px 0; font-size: 1rem; color: #aaa; border-bottom: 1px solid #333; padding-bottom: 5px; }

        /* ASCII Board */
        .ascii-panel { flex: 0 0 auto; background: #151515; border: 1px solid #333; border-radius: 5px; padding: 15px; display: flex; flex-direction: column; align-items: center; }
        #asciiDisplay {
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace; font-size: 18px; line-height: 1.5; white-space: pre;
            color: #e0e0e0; background: #0f0f0f; padding: 15px; border: 2px solid #444; border-radius: 4px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        /* Chat Window (New!) */
        .chat-panel { flex: 1; background: #151515; border: 1px solid #333; border-radius: 5px; display: flex; flex-direction: column; overflow: hidden; }
        #chatHistory { flex: 1; overflow-y: auto; padding: 10px; font-size: 12px; display: flex; flex-direction: column; gap: 8px; }
        .chat-input-area { padding: 10px; border-top: 1px solid #333; background: #252526; display: flex; gap: 5px; }

        .msg { padding: 5px 8px; border-radius: 4px; max-width: 85%; word-wrap: break-word; }
        .msg-me { align-self: flex-end; background: #1e4620; color: #cfc; border: 1px solid #2e6b30; }
        .msg-other { align-self: flex-start; background: #333; color: #ddd; border: 1px solid #444; }
        .msg-meta { font-size: 10px; opacity: 0.6; margin-bottom: 2px; display: block; }

        /* Form Elements */
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #888; font-size: 0.8rem; }
        input[type="text"], input[type="password"], input[type="email"], textarea { background: #444; color: white; border: 1px solid #555; padding: 8px; width: 100%; box-sizing: border-box; margin-bottom: 8px; font-family: monospace; }

        /* Buttons */
        button { cursor: pointer; padding: 8px; background: #007bff; color: white; border: none; width: 100%; font-weight: bold; border-radius: 3px; margin-bottom: 5px; }
        button:disabled { background: #444; cursor: not-allowed; color: #888; }
        button:hover:not(:disabled) { background: #0056b3; }
        .btn-red { background: #dc3545; } .btn-red:hover:not(:disabled) { background: #a71d2a; }
        .btn-green { background: #28a745; } .btn-green:hover:not(:disabled) { background: #1e7e34; }
        .btn-purple { background: #6f42c1; } .btn-purple:hover:not(:disabled) { background: #59359a; }

        /* Logs */
        .log-header { padding: 10px; border-bottom: 1px solid #333; background: #252526; display: flex; justify-content: space-between; align-items: center; }
        #logContent { flex: 1; overflow-y: auto; padding: 5px; font-size: 12px; line-height: 1.4; font-family: 'Consolas', monospace; }
        .log-entry { border-bottom: 1px solid #222; }
        .log-summary { display: flex; align-items: center; padding: 4px; cursor: pointer; }
        .log-summary:hover { background-color: #2a2d2e; }
        .json-box { display: none; background: #181818; padding: 10px; margin-left: 20px; border-left: 2px solid #444; color: #a9b7c6; overflow-x: auto; }
        .expanded .json-box { display: block; }

        .c-sys { color: #dcdcaa; } .c-out { color: #569cd6; } .c-in { color: #6a9955; } .c-err { color: #f44747; }
    </style>
</head>
<body>

<div style="margin-bottom: 10px;">
    <h1 style="margin:0; font-size: 1.5rem;">‚ôüÔ∏è DeepDame Smart Debugger v2.2</h1>
</div>

<div class="container">

    <div class="controls">
        <div class="box">
            <h3>1. Authentication</h3>
            <form onsubmit="performLogin(event)">
                <input type="email" id="email" placeholder="Email" value="test@deepdame.com">
                <input type="password" id="password" placeholder="Password" value="password123">
                <button type="submit" id="loginBtn">Login & Set Cookie</button>
            </form>
            <div id="authStatus" style="margin-top:5px; font-size:12px;">Waiting...</div>
        </div>

        <div class="box">
            <h3>2. Connection</h3>
            <div style="display: flex; gap: 5px;">
                <button id="connectBtn" onclick="connect()" disabled>Connect WS</button>
                <button id="disconnectBtn" onclick="disconnect()" disabled class="btn-red">Disconnect</button>
            </div>
        </div>

        <div class="box">
            <h3>3. Lobby</h3>
            <div style="display: flex; gap: 5px; margin-bottom: 5px;">
                <button onclick="createGame('PVP')" id="createBtn" disabled>Create PVP</button>
                <button onclick="createGame('PVE')" id="createPveBtn" class="btn-purple" disabled>Create PVE ü§ñ</button>
            </div>
            <button onclick="findMatch()" id="matchBtn" class="btn-green" disabled>Auto Match üé≤</button>
            <button onclick="refreshLobby()" style="background: #555; font-size: 11px; margin-top: 5px;">Refresh Lobby List</button>
            <div id="lobbyList" style="height:100px; overflow-y:auto; background:#222; border:1px solid #333; margin-top:5px;"></div>
        </div>

        <div class="box">
            <h3>4. Game Actions</h3>
            <label>Target Game ID:</label>
            <input type="text" id="gameIdInput" placeholder="UUID..." readonly />
            <button id="surrenderBtn" onclick="surrender()" class="btn-red" disabled style="margin-top:5px;">Surrender üè≥Ô∏è</button>

            <hr style="border:0; border-top:1px solid #444; margin: 10px 0;">

            <label>Make Move (JSON):</label>
            <div style="display: flex; gap: 5px; margin-bottom: 5px;">
                <input type="text" id="fromCoord" placeholder="From (0,0)" style="margin:0; text-align:center;">
                <input type="text" id="toCoord" placeholder="To (1,1)" style="margin:0; text-align:center;">
            </div>
            <button onclick="makeMoveFromInputs()" id="moveBtn" disabled>Send Move</button>
        </div>
    </div>

    <div class="center-column">
        <div class="ascii-panel">
            <h3>Board View</h3>
            <div id="asciiDisplay">Board not initialized</div>
            <button onclick="initLocalBoard()" style="width:auto; margin-top:10px; background:#444; font-size:11px;">Reset Board</button>
        </div>

        <div class="chat-panel">
            <div style="padding: 10px; background: #252526; border-bottom: 1px solid #333; font-weight: bold; font-size: 13px;">
                üí¨ Game Chat
            </div>
            <div id="chatHistory">
                <div style="text-align: center; color: #555; font-style: italic;">Join a game to chat</div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chatInput" placeholder="Type message..." onkeydown="if(event.key==='Enter') sendChat()" disabled style="margin:0;">
                <button onclick="sendChat()" id="sendChatBtn" disabled style="width: auto; margin:0;">Send</button>
            </div>
        </div>
    </div>

    <div class="logs-panel">
        <div class="log-header">
            <strong>üì° Traffic Inspector</strong>
            <button onclick="document.getElementById('logContent').innerHTML=''" style="width:auto; padding: 2px 10px; font-size: 12px;">Clear</button>
        </div>
        <div id="logContent"></div>
    </div>
</div>

<script>
    let stompClient = null;
    let currentUserEmail = "";
    const API_BASE = "/api/v1";
    const WS_URL = "ws://" + window.location.host + "/ws/websocket";

    // --- ASCII BOARD LOGIC ---
    let localGrid = [];
    function initLocalBoard() {
        localGrid = Array(8).fill(null).map(() => Array(8).fill('.'));
        for (let row = 0; row < 8; row++) {
            for (let col = 0; col < 8; col++) {
                if ((row + col) % 2 !== 0) {
                    if (row < 3) localGrid[row][col] = 'w';
                    else if (row > 4) localGrid[row][col] = 'b';
                }
            }
        }
        renderAscii();
    }

    function renderAscii() {
        if(localGrid.length === 0) return;
        let output = "   0 1 2 3 4 5 6 7\n\n";
        for (let r = 0; r < 8; r++) {
            output += `${r} |`;
            for (let c = 0; c < 8; c++) {
                output += ` ${localGrid[r][c]}`;
            }
            output += "\n";
        }
        document.getElementById('asciiDisplay').innerText = output;
    }

    function handleMoveUpdate(jsonBody) {
        try {
            const move = JSON.parse(jsonBody);
            if (move.from && move.to) {
                const f = move.from;
                const t = move.to;
                if (!localGrid[f.row] || !localGrid[t.row]) return;
                const piece = localGrid[f.row][f.col];
                localGrid[t.row][t.col] = piece;
                localGrid[f.row][f.col] = '.';
                if (Math.abs(f.row - t.row) === 2) {
                    localGrid[(f.row + t.row) / 2][(f.col + t.col) / 2] = '.';
                }
                renderAscii();
            }
        } catch (e) { console.error(e); }
    }

    // --- 1. LOGIN ---
    async function performLogin(e) {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        try {
            const response = await fetch(`${API_BASE}/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            if (response.ok) {
                currentUserEmail = email; // Store for chat
                document.getElementById('authStatus').innerHTML = "<span style='color:#28a745'>‚úÖ Logged In</span>";
                document.getElementById('connectBtn').disabled = false;
                log("‚úÖ Login Success", 'c-sys');
            } else { throw new Error(response.status); }
        } catch (err) { log("‚ùå Login Failed", 'c-err'); }
    }

    // --- 2. WEBSOCKET ---
    function connect() {
        stompClient = new StompJs.Client({ brokerURL: WS_URL, reconnectDelay: 0 });
        stompClient.onConnect = (frame) => {
            log("‚úÖ STOMP CONNECTED", 'c-sys');
            setConnected(true);
            refreshLobby();
            initLocalBoard();

            stompClient.subscribe('/user/queue/errors', (msg) => log(`‚ùå ERROR: ${msg.body}`, 'c-err'));

            stompClient.subscribe('/user/queue/game/created', (msg) => {
                const body = JSON.parse(msg.body);
                const id = body.gameId || body;
                log(`üéâ GAME CREATED: ${id}`, 'c-in');
                subscribeToGame(id);
            });

            stompClient.subscribe('/user/queue/game/joined', (msg) => {
                const body = JSON.parse(msg.body);
                log(`ü§ù JOINED GAME: ${body.gameId}`, 'c-in');
                subscribeToGame(body.gameId);
            });
        };
        stompClient.activate();
    }

    function disconnect() {
        if (stompClient) stompClient.deactivate();
        setConnected(false);
        log("üîå Disconnected", 'c-sys');
    }

    // --- 3. GAME LOGIC ---
    function createGame(mode) {
        if(!stompClient?.connected) return;
        stompClient.publish({
            destination: '/app/game/create',
            body: JSON.stringify(mode),
            headers: { 'content-type': 'application/json' }
        });
    }

    function joinGame(id) {
        stompClient.publish({ destination: `/app/game/${id}/join` });
    }

    function makeMoveFromInputs() {
        const id = document.getElementById('gameIdInput').value;
        const fromVal = document.getElementById('fromCoord').value.split(','); // "0,1"
        const toVal = document.getElementById('toCoord').value.split(','); // "1,2"

        if(fromVal.length !== 2 || toVal.length !== 2) { alert("Use format row,col (e.g. 2,1)"); return; }

        const payload = {
            from: { row: parseInt(fromVal[0]), col: parseInt(fromVal[1]) },
            to: { row: parseInt(toVal[0]), col: parseInt(toVal[1]) }
        };

        log(`üöÄ SEND MOVE`, 'c-out', JSON.stringify(payload));
        stompClient.publish({
            destination: `/app/game/${id}/move`,
            body: JSON.stringify(payload),
            headers: { 'content-type': 'application/json' }
        });
    }

    function surrender() {
        const id = document.getElementById('gameIdInput').value;
        if (id && confirm("Surrender?")) stompClient.publish({ destination: `/app/game/${id}/surrender` });
    }

    // --- 4. CHAT LOGIC ---
    function sendChat() {
        const id = document.getElementById('gameIdInput').value;
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        if(!id || !text) return;

        stompClient.publish({
            destination: `/app/game/${id}/chat`,
            body: JSON.stringify({ content: text }),
            headers: { 'content-type': 'application/json' }
        });
        input.value = "";
    }

    function addChatMessage(msg) {
        const history = document.getElementById('chatHistory');
        const div = document.createElement('div');
        const isMe = msg.sender === currentUserEmail;

        div.className = `msg ${isMe ? 'msg-me' : 'msg-other'}`;
        div.innerHTML = `<span class="msg-meta">${isMe ? 'You' : msg.sender} ‚Ä¢ ${new Date(msg.timestamp).toLocaleTimeString()}</span>${msg.content}`;

        history.appendChild(div);
        history.scrollTop = history.scrollHeight;
    }

    // --- SUBSCRIPTION MANAGER ---
    function subscribeToGame(id) {
        if (document.getElementById('gameIdInput').value === id) return;
        document.getElementById('gameIdInput').value = id;
        document.getElementById('chatHistory').innerHTML = ''; // Clear old chat

        // Enable Chat UI
        document.getElementById('chatInput').disabled = false;
        document.getElementById('sendChatBtn').disabled = false;

        // 1. Move Updates
        stompClient.subscribe(`/topic/game/${id}`, (msg) => {
            log(`‚ôüÔ∏è MOVE`, 'c-in', msg.body);
            handleMoveUpdate(msg.body);
        });

        // 2. Chat Updates (NEW!)
        stompClient.subscribe(`/topic/game/${id}/chat`, (msg) => {
            const chatMsg = JSON.parse(msg.body);
            addChatMessage(chatMsg);
        });

        // 3. Game Over
        stompClient.subscribe(`/topic/game/${id}/game-over`, (msg) => {
            const data = JSON.parse(msg.body);
            log(`üèÜ GAME OVER: ${data.winnerColor}`, 'c-sys');
            alert(`Winner: ${data.winnerColor}`);
        });
    }

    // --- HELPERS & LOGS ---
    function log(summary, type, detail) {
        const c = document.getElementById('logContent');
        const d = document.createElement('div');
        d.className = 'log-entry';
        let h = `<div class="log-summary" onclick="this.parentElement.classList.toggle('expanded')"><span class="time">${new Date().toLocaleTimeString()}</span><span class="${type}">${summary}</span></div>`;
        if(detail) h += `<div class="json-box"><pre>${detail}</pre></div>`;
        d.innerHTML = h;
        c.appendChild(d);
        c.scrollTop = c.scrollHeight;
    }

    async function refreshLobby() {
        try {
            const res = await fetch(`${API_BASE}/lobby/open`);
            const ids = await res.json();
            const list = document.getElementById('lobbyList');
            list.innerHTML = "";
            ids.forEach(id => {
                list.innerHTML += `<div style="padding:4px; border-bottom:1px solid #333; font-size:11px;"><span>..${id.slice(-8)}</span><button onclick="joinGame('${id}')" style="font-size:10px; padding:1px 5px; float:right;">Join</button></div>`;
            });
        } catch (e) {}
    }

    function setConnected(connected) {
        document.querySelectorAll('button').forEach(b => {
            if(b.id !== 'loginBtn' && b.id !== 'connectBtn' && b.id !== 'disconnectBtn') b.disabled = !connected;
        });
        document.getElementById('connectBtn').disabled = connected;
        document.getElementById('disconnectBtn').disabled = !connected;
    }
</script>
</body>
</html>