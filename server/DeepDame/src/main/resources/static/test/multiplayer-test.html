<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DeepDame Smart Debugger v2</title>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    <style>
        body { font-family: 'Consolas', 'Segoe UI', monospace; padding: 20px; background: #1e1e1e; color: #c0c0c0; margin: 0; height: 100vh; display: flex; flex-direction: column; }

        /* Layout */
        .container { display: flex; gap: 20px; flex: 1; min-height: 0; }
        .controls { width: 360px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }
        .ascii-panel { width: 340px; display: flex; flex-direction: column; background: #151515; border: 1px solid #333; border-radius: 5px; align-items: center; justify-content: center; }
        .logs-panel { flex: 1; background: #111; border: 1px solid #333; display: flex; flex-direction: column; border-radius: 5px; }

        /* ASCII Board Styling */
        #asciiDisplay {
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 18px;
            line-height: 1.5;
            white-space: pre;
            color: #e0e0e0;
            background: #0f0f0f;
            padding: 20px;
            border: 2px solid #444;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        /* Boxes & Inputs */
        .box { background: #2d2d2d; border: 1px solid #444; padding: 15px; border-radius: 5px; }
        h2 { border-bottom: 2px solid #007bff; padding-bottom: 5px; margin-top: 0; font-size: 1.2rem; color: #fff; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #888; font-size: 0.8rem; }
        input[type="text"], input[type="password"], input[type="email"], textarea { background: #444; color: white; border: 1px solid #555; padding: 8px; width: 100%; box-sizing: border-box; margin-bottom: 8px; font-family: monospace; }

        /* Coord Inputs */
        .coord-row { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; }
        .coord-input { width: 40px !important; text-align: center; margin-bottom: 0 !important; }

        /* Buttons */
        button { cursor: pointer; padding: 8px; background: #007bff; color: white; border: none; width: 100%; font-weight: bold; border-radius: 3px; margin-bottom: 5px; }
        button:disabled { background: #444; cursor: not-allowed; color: #888; }
        button:hover:not(:disabled) { background: #0056b3; }
        .btn-red { background: #dc3545; }
        .btn-red:hover:not(:disabled) { background: #a71d2a; }
        .btn-green { background: #28a745; }
        .btn-green:hover:not(:disabled) { background: #1e7e34; }

        /* Interactive Logs */
        .log-header { padding: 10px; border-bottom: 1px solid #333; background: #252526; display: flex; justify-content: space-between; align-items: center; }
        #logContent { flex: 1; overflow-y: auto; padding: 5px; font-size: 12px; line-height: 1.4; font-family: 'Consolas', monospace; }
        .log-entry { border-bottom: 1px solid #222; }
        .log-summary { display: flex; align-items: center; padding: 4px; cursor: pointer; user-select: none; }
        .log-summary:hover { background-color: #2a2d2e; }
        .arrow { display: inline-block; width: 15px; color: #777; transition: transform 0.15s; font-size: 10px; }
        .expanded .arrow { transform: rotate(90deg); }
        .time { color: #555; margin-right: 10px; font-size: 11px; min-width: 60px; }
        .json-box { display: none; background: #181818; padding: 10px; margin-left: 20px; border-left: 2px solid #444; color: #a9b7c6; overflow-x: auto; }
        .expanded .json-box { display: block; animation: fadeIn 0.2s; }

        /* Log Colors */
        .c-sys { color: #dcdcaa; }
        .c-out { color: #569cd6; }
        .c-in { color: #6a9955; }
        .c-err { color: #f44747; }
    </style>
</head>
<body>

<div style="margin-bottom: 10px;">
    <h1 style="margin:0; font-size: 1.5rem;">‚ôüÔ∏è DeepDame Smart Debugger v2</h1>
</div>

<div class="container">
    <div class="controls">
        <div class="box">
            <h2>1. Authentication</h2>
            <form onsubmit="performLogin(event)">
                <input type="email" id="email" placeholder="Email" value="test@deepdame.com">
                <input type="password" id="password" placeholder="Password" value="password123">
                <button type="submit" id="loginBtn">Login & Set Cookie</button>
            </form>
            <div id="authStatus" style="margin-top:5px; font-size:12px;">Waiting...</div>
        </div>

        <div class="box">
            <h2>2. Connection</h2>
            <div style="display: flex; gap: 5px;">
                <button id="connectBtn" onclick="connect()" disabled>Connect WS</button>
                <button id="disconnectBtn" onclick="disconnect()" disabled class="btn-red">Disconnect</button>
            </div>
        </div>

        <div class="box">
            <h2>3. Lobby & Match</h2>
            <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                <button onclick="createGame()" id="createBtn" disabled>Create Game</button>
                <button onclick="findMatch()" id="matchBtn" class="btn-green" disabled>Auto Match üé≤</button>
            </div>

            <button onclick="refreshLobby()" style="background: #555; font-size: 11px;">Refresh Lobby List</button>
            <div id="lobbyList" style="height:100px; overflow-y:auto; background:#222; border:1px solid #333; margin-top:5px;"></div>
        </div>

        <div class="box">
            <h2>4. Game Actions</h2>
            <label>Target Game ID:</label>
            <input type="text" id="gameIdInput" placeholder="UUID..." readonly />

            <label style="margin-top:10px; color:#fff;">Quick Move Input:</label>
            <div class="coord-row">
                <span style="font-size:11px; width:40px;">FROM:</span>
                <input type="text" class="coord-input" id="fromR" placeholder="R" oninput="updateJson()">
                <input type="text" class="coord-input" id="fromC" placeholder="C" oninput="updateJson()">
                <span style="margin:0 5px;">‚ûî</span>
                <span style="font-size:11px; width:30px;">TO:</span>
                <input type="text" class="coord-input" id="toR" placeholder="R" oninput="updateJson()">
                <input type="text" class="coord-input" id="toC" placeholder="C" oninput="updateJson()">
            </div>

            <label>Generated JSON:</label>
            <textarea id="movePayload" rows="4" readonly style="background:#222; color:#777;">{
  "from": { "row": 0, "col": 0 },
  "to": { "row": 0, "col": 0 }
}</textarea>
            <button id="moveBtn" onclick="makeMove()" disabled>Send Move</button>
            <button id="surrenderBtn" onclick="surrender()" class="btn-red" disabled style="margin-top:10px;">Surrender üè≥Ô∏è</button>
        </div>
    </div>

    <div class="ascii-panel">
        <h3 style="margin-top:0; color:#888;">Client-Side View</h3>
        <div id="asciiDisplay">Board not initialized</div>
        <button onclick="initLocalBoard()" style="width:auto; margin-top:10px; background:#444; font-size:11px;">Reset Board</button>
        <div style="font-size:10px; color:#555; margin-top:5px;">(Updates on server broadcast)</div>
    </div>

    <div class="logs-panel">
        <div class="log-header">
            <strong>üì° Traffic Inspector</strong>
            <button onclick="document.getElementById('logContent').innerHTML=''" style="width:auto; padding: 2px 10px; font-size: 12px;">Clear</button>
        </div>
        <div id="logContent"></div>
    </div>
</div>

<script>
    let stompClient = null;
    const API_BASE = "/api/v1";
    const WS_URL = "ws://" + window.location.host + "/ws/websocket";

    // --- JSON AUTO-UPDATER ---
    function updateJson() {
        const fR = document.getElementById('fromR').value || 0;
        const fC = document.getElementById('fromC').value || 0;
        const tR = document.getElementById('toR').value || 0;
        const tC = document.getElementById('toC').value || 0;

        const payload = {
            from: { row: parseInt(fR), col: parseInt(fC) },
            to: { row: parseInt(tR), col: parseInt(tC) }
        };
        document.getElementById('movePayload').value = JSON.stringify(payload, null, 2);
    }

    // --- ASCII BOARD LOGIC ---
    let localGrid = [];

    function initLocalBoard() {
        localGrid = Array(8).fill(null).map(() => Array(8).fill('.'));
        for (let row = 0; row < 8; row++) {
            for (let col = 0; col < 8; col++) {
                if ((row + col) % 2 !== 0) {
                    if (row < 3) localGrid[row][col] = 'w';
                    else if (row > 4) localGrid[row][col] = 'b';
                }
            }
        }
        renderAscii();
        log("üñ•Ô∏è Local Board Reset", 'c-sys');
    }

    function renderAscii() {
        if(localGrid.length === 0) return;
        let output = "   0 1 2 3 4 5 6 7\n\n";
        for (let r = 0; r < 8; r++) {
            output += `${r} |`;
            for (let c = 0; c < 8; c++) {
                output += ` ${localGrid[r][c]}`;
            }
            output += "\n";
        }
        document.getElementById('asciiDisplay').innerText = output;
    }

    function handleMoveUpdate(jsonBody) {
        try {
            const move = JSON.parse(jsonBody);
            if (move.from && move.to) {
                const f = move.from;
                const t = move.to;

                // Safety check for array bounds
                if (!localGrid[f.row] || !localGrid[t.row]) return;

                const piece = localGrid[f.row][f.col];
                localGrid[t.row][t.col] = piece;
                localGrid[f.row][f.col] = '.';

                // Handle Jump
                if (Math.abs(f.row - t.row) === 2) {
                    const midRow = (f.row + t.row) / 2;
                    const midCol = (f.col + t.col) / 2;
                    localGrid[midRow][midCol] = '.';
                    log(`‚öîÔ∏è Capture at [${midRow},${midCol}]`, 'c-sys');
                }
                renderAscii();
            }
        } catch (e) {
            console.error("Failed to parse move", e);
        }
    }

    // --- LOGGING ENGINE ---
    function log(summary, type = 'c-sys', detailObj = null) {
        const container = document.getElementById('logContent');
        const time = new Date().toLocaleTimeString().split(' ')[0] + "." + new Date().getMilliseconds();
        const entryDiv = document.createElement('div');
        entryDiv.className = 'log-entry';
        const arrowHtml = detailObj ? '<span class="arrow">‚ñ∂</span>' : '<span class="arrow" style="opacity:0">‚ñ∂</span>';
        const cursorStyle = detailObj ? '' : 'style="cursor:default"';
        let html = `<div class="log-summary" ${cursorStyle} onclick="toggleLog(this)">
                    ${arrowHtml}<span class="time">[${time}]</span><span class="${type}">${summary}</span></div>`;
        if (detailObj) {
            let jsonStr = "";
            try {
                const obj = (typeof detailObj === 'string') ? JSON.parse(detailObj) : detailObj;
                jsonStr = JSON.stringify(obj, null, 2);
            } catch(e) { jsonStr = detailObj; }
            jsonStr = jsonStr.replace(/"(.*?)":/g, '<span style="color:#9cdcfe">"$1"</span>:').replace(/: "(.*?)"/g, ': <span style="color:#ce9178">"$1"</span>').replace(/: (\d+)/g, ': <span style="color:#b5cea8">$1</span>');
            html += `<div class="json-box"><pre style="margin:0">${jsonStr}</pre></div>`;
        }
        entryDiv.innerHTML = html;
        container.appendChild(entryDiv);
        container.scrollTop = container.scrollHeight;
    }

    window.toggleLog = function(element) {
        const entry = element.parentElement;
        if(entry.querySelector('.json-box')) entry.classList.toggle('expanded');
    };

    // --- 1. LOGIN ---
    async function performLogin(e) {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        log("üîê Attempting HTTP Login...", 'c-sys');
        try {
            const response = await fetch(`${API_BASE}/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            if (response.ok) {
                document.getElementById('authStatus').innerHTML = "<span style='color:#28a745'>‚úÖ Logged In</span>";
                document.getElementById('connectBtn').disabled = false;
                log("‚úÖ Login Success", 'c-sys');
            } else { throw new Error(response.status); }
        } catch (err) { log("‚ùå Login Failed: " + err.message, 'c-err'); }
    }

    // --- 2. WEBSOCKET ---
    function connect() {
        log(`üîå Connecting to ${WS_URL}...`, 'c-sys');
        stompClient = new StompJs.Client({ brokerURL: WS_URL, reconnectDelay: 0 });

        stompClient.onConnect = (frame) => {
            log("‚úÖ <b>STOMP CONNECTED</b>", 'c-sys');
            setConnected(true);
            refreshLobby();
            initLocalBoard();

            stompClient.subscribe('/user/queue/errors', (msg) => log(`‚ùå ERROR RECEIVED`, 'c-err', msg.body));

            stompClient.subscribe('/user/queue/game/created', (msg) => {
                const body = JSON.parse(msg.body);
                const id = body.gameId || body;
                document.getElementById('gameIdInput').value = id;
                log(`üéâ GAME CREATED: ${id}`, 'c-in', msg.body);
                subscribeToGame(id);
            });

            stompClient.subscribe('/user/queue/game/joined', (msg) => {
                const body = JSON.parse(msg.body);
                document.getElementById('gameIdInput').value = body.gameId;
                log(`ü§ù JOIN CONFIRMED`, 'c-in', msg.body);
                subscribeToGame(body.gameId);
            });
        };

        stompClient.onStompError = (frame) => log("‚ùå BROKER ERROR", 'c-err', frame.headers['message']);
        stompClient.activate();
    }

    function disconnect() {
        if (stompClient) stompClient.deactivate();
        setConnected(false);
        log("üîå Disconnected", 'c-sys');
    }

    // --- 3. ACTIONS ---
    function createGame() {
        if(!stompClient || !stompClient.connected) return;
        const payload = "PVP";
        log(`üì§ SEND CREATE`, 'c-out', payload);
        stompClient.publish({ destination: '/app/game/create', body: JSON.stringify(payload), headers: { 'content-type': 'application/json' } });
    }

    function findMatch() {
        if(!stompClient || !stompClient.connected) return;
        log(`üé≤ REQUEST MATCHMAKING`, 'c-out');
        stompClient.publish({ destination: '/app/game/matchmaking' });
    }

    function joinGame(id) {
        log(`üì§ SEND JOIN (${id})`, 'c-out');
        stompClient.publish({ destination: `/app/game/${id}/join` });
    }

    function makeMove() {
        const id = document.getElementById('gameIdInput').value;
        const rawBody = document.getElementById('movePayload').value;
        log(`üöÄ SEND MOVE`, 'c-out', rawBody);
        stompClient.publish({ destination: `/app/game/${id}/move`, body: rawBody, headers: { 'content-type': 'application/json' } });
    }

    function surrender() {
        const id = document.getElementById('gameIdInput').value;
        if (!id) { log("‚ùå No Game ID selected", 'c-err'); return; }

        if (confirm("Are you sure you want to surrender?")) {
            log(`üè≥Ô∏è SURRENDER (${id})`, 'c-out');
            stompClient.publish({ destination: `/app/game/${id}/surrender` });
        }
    }

    function subscribeToGame(id) {
        if (stompClient.subscriptions && Object.keys(stompClient.subscriptions).some(k => k.includes(id))) return;
        log(`üì° Subscribed to game channel`, 'c-sys');

        stompClient.subscribe(`/topic/game/${id}`, (msg) => {
            log(`‚ôüÔ∏è BOARD UPDATE`, 'c-in', msg.body);
            handleMoveUpdate(msg.body);
        });

        stompClient.subscribe(`/topic/game/${id}/game-over`, (msg) => {
            const data = JSON.parse(msg.body);
            log(`üèÜ GAME OVER! Winner: ${data.winnerColor}`, 'c-sys', msg.body);
            alert(`GAME OVER\nWinner: ${data.winnerColor} (${data.winnerName})`);

            // --- FIX: WE NO LONGER DISABLE BUTTONS HERE ---
            // This allows you to immediately Create/Match a new game without refreshing
        });
    }

    // --- HELPERS ---
    async function refreshLobby() {
        try {
            const res = await fetch(`${API_BASE}/lobby/open`);
            const ids = await res.json();
            const list = document.getElementById('lobbyList');
            list.innerHTML = "";
            ids.forEach(id => {
                list.innerHTML += `<div style="padding:4px; border-bottom:1px solid #333; font-size:11px;">
                        <span>..${id.slice(-8)}</span>
                        <button onclick="joinGame('${id}')" style="font-size:10px; padding:1px 5px; float:right;">Join</button></div>`;
            });
        } catch (e) { log("Lobby fetch error", 'c-err'); }
    }

    function setConnected(connected) {
        document.getElementById('connectBtn').disabled = connected;
        document.getElementById('disconnectBtn').disabled = !connected;

        // Always enabled if connected, regardless of turn or game state
        document.getElementById('createBtn').disabled = !connected;
        document.getElementById('matchBtn').disabled = !connected;
        document.getElementById('moveBtn').disabled = !connected;
        document.getElementById('surrenderBtn').disabled = !connected;
    }
</script>
</body>
</html>