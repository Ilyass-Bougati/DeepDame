<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DeepDame Smart Debugger + ASCII</title>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    <style>
        body { font-family: 'Consolas', 'Segoe UI', monospace; padding: 20px; background: #1e1e1e; color: #c0c0c0; margin: 0; height: 100vh; display: flex; flex-direction: column; }

        /* Layout - Updated to 3 columns */
        .container { display: flex; gap: 20px; flex: 1; min-height: 0; }
        .controls { width: 350px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }
        .ascii-panel { width: 300px; display: flex; flex-direction: column; background: #151515; border: 1px solid #333; border-radius: 5px; align-items: center; justify-content: center; }
        .logs-panel { flex: 1; background: #111; border: 1px solid #333; display: flex; flex-direction: column; border-radius: 5px; }

        /* ASCII Board Styling */
        #asciiDisplay {
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 18px;
            line-height: 1.5;
            white-space: pre;
            color: #e0e0e0;
            background: #0f0f0f;
            padding: 20px;
            border: 2px solid #444;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        /* Boxes & Inputs */
        .box { background: #2d2d2d; border: 1px solid #444; padding: 15px; border-radius: 5px; }
        h2 { border-bottom: 2px solid #007bff; padding-bottom: 5px; margin-top: 0; font-size: 1.2rem; color: #fff; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #888; font-size: 0.8rem; }
        input, textarea { background: #444; color: white; border: 1px solid #555; padding: 8px; width: 100%; box-sizing: border-box; margin-bottom: 8px; font-family: monospace; }
        button { cursor: pointer; padding: 8px; background: #007bff; color: white; border: none; width: 100%; font-weight: bold; border-radius: 3px; }
        button:disabled { background: #444; cursor: not-allowed; color: #888; }
        button:hover:not(:disabled) { background: #0056b3; }

        /* Interactive Logs */
        .log-header { padding: 10px; border-bottom: 1px solid #333; background: #252526; display: flex; justify-content: space-between; align-items: center; }
        #logContent { flex: 1; overflow-y: auto; padding: 5px; font-size: 12px; line-height: 1.4; font-family: 'Consolas', monospace; }
        .log-entry { border-bottom: 1px solid #222; }
        .log-summary { display: flex; align-items: center; padding: 4px; cursor: pointer; user-select: none; }
        .log-summary:hover { background-color: #2a2d2e; }
        .arrow { display: inline-block; width: 15px; color: #777; transition: transform 0.15s; font-size: 10px; }
        .expanded .arrow { transform: rotate(90deg); }
        .time { color: #555; margin-right: 10px; font-size: 11px; min-width: 60px; }
        .json-box { display: none; background: #181818; padding: 10px; margin-left: 20px; border-left: 2px solid #444; color: #a9b7c6; overflow-x: auto; }
        .expanded .json-box { display: block; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Log Colors */
        .c-sys { color: #dcdcaa; }
        .c-out { color: #569cd6; }
        .c-in { color: #6a9955; }
        .c-err { color: #f44747; }
    </style>
</head>
<body>

<div style="margin-bottom: 10px;">
    <h1 style="margin:0; font-size: 1.5rem;">‚ôüÔ∏è DeepDame Smart Debugger</h1>
</div>

<div class="container">
    <div class="controls">
        <div class="box">
            <h2>1. Authentication</h2>
            <form onsubmit="performLogin(event)">
                <input type="email" id="email" placeholder="Email" value="test@deepdame.com">
                <input type="password" id="password" placeholder="Password" value="password123">
                <button type="submit" id="loginBtn">Login & Set Cookie</button>
            </form>
            <div id="authStatus" style="margin-top:5px; font-size:12px;">Waiting...</div>
        </div>

        <div class="box">
            <h2>2. Connection</h2>
            <div style="display: flex; gap: 5px;">
                <button id="connectBtn" onclick="connect()" disabled>Connect WS</button>
                <button id="disconnectBtn" onclick="disconnect()" disabled style="background:#dc3545">Disconnect</button>
            </div>
        </div>

        <div class="box">
            <h2>3. Lobby</h2>
            <button onclick="refreshLobby()" style="background: #555; margin-bottom: 5px;">Refresh List</button>
            <div id="lobbyList" style="height:100px; overflow-y:auto; background:#222; border:1px solid #333;"></div>
        </div>

        <div class="box">
            <h2>4. Actions</h2>
            <button id="createBtn" onclick="createGame()" disabled>Create Game (PVP)</button>
            <br><br>
            <label>Target Game ID:</label>
            <input type="text" id="gameIdInput" placeholder="UUID..." readonly />

            <label>Move JSON:</label>
            <textarea id="movePayload" rows="6">{
  "from": { "row": 5, "col": 0 },
  "to": { "row": 4, "col": 1 }
}</textarea>
            <button id="moveBtn" onclick="makeMove()" disabled>Send Move</button>
        </div>
    </div>

    <div class="ascii-panel">
        <h3 style="margin-top:0; color:#888;">Client-Side State</h3>
        <div id="asciiDisplay">Board not initialized</div>
        <button onclick="initLocalBoard()" style="width:auto; margin-top:10px; background:#444; font-size:11px;">Reset Board</button>
    </div>

    <div class="logs-panel">
        <div class="log-header">
            <strong>üì° Traffic Inspector</strong>
            <button onclick="document.getElementById('logContent').innerHTML=''" style="width:auto; padding: 2px 10px; font-size: 12px;">Clear</button>
        </div>
        <div id="logContent"></div>
    </div>
</div>

<script>
    let stompClient = null;
    const API_BASE = "/api/v1";
    const WS_URL = "ws://" + window.location.host + "/ws/websocket";

    // --- ASCII BOARD LOGIC ---
    let localGrid = [];

    function initLocalBoard() {
        // Initialize 8x8 grid with '.'
        localGrid = Array(8).fill(null).map(() => Array(8).fill('.'));

        // Apply Logic: (row + col) % 2 != 0 are dark squares
        // Rows 0-2: White ('w'), Rows 5-7: Black ('b')
        for (let row = 0; row < 8; row++) {
            for (let col = 0; col < 8; col++) {
                if ((row + col) % 2 !== 0) {
                    if (row < 3) localGrid[row][col] = 'w';
                    else if (row > 4) localGrid[row][col] = 'b';
                }
            }
        }
        renderAscii();
        log("üñ•Ô∏è Local Board Initialized", 'c-sys');
    }

    function renderAscii() {
        if(localGrid.length === 0) return;

        // Header
        let output = "   0 1 2 3 4 5 6 7\n\n";

        for (let r = 0; r < 8; r++) {
            output += `${r} |`; // Row Number
            for (let c = 0; c < 8; c++) {
                output += ` ${localGrid[r][c]}`;
            }
            output += "\n";
        }
        document.getElementById('asciiDisplay').innerText = output;
    }

    function handleMoveUpdate(jsonBody) {
        try {
            const move = JSON.parse(jsonBody);
            // Check if this looks like a move object
            if (move.from && move.to) {
                const f = move.from;
                const t = move.to;

                // 1. Move the piece in local memory
                const piece = localGrid[f.row][f.col];
                localGrid[t.row][t.col] = piece;
                localGrid[f.row][f.col] = '.';

                // 2. Handle Jump (Simple Logic)
                // If row difference is 2, remove the middle piece
                if (Math.abs(f.row - t.row) === 2) {
                    const midRow = (f.row + t.row) / 2;
                    const midCol = (f.col + t.col) / 2;
                    localGrid[midRow][midCol] = '.';
                    log(`‚öîÔ∏è Capture at [${midRow},${midCol}]`, 'c-sys');
                }

                renderAscii();
            }
        } catch (e) {
            console.error("Failed to parse move for ASCII update", e);
        }
    }

    // --- EXISTING LOGGING & APP LOGIC ---

    // (Logging Engine kept exactly as is)
    function log(summary, type = 'c-sys', detailObj = null) {
        const container = document.getElementById('logContent');
        const time = new Date().toLocaleTimeString().split(' ')[0] + "." + new Date().getMilliseconds();
        const entryDiv = document.createElement('div');
        entryDiv.className = 'log-entry';
        const arrowHtml = detailObj ? '<span class="arrow">‚ñ∂</span>' : '<span class="arrow" style="opacity:0">‚ñ∂</span>';
        const cursorStyle = detailObj ? '' : 'style="cursor:default"';
        let html = `<div class="log-summary" ${cursorStyle} onclick="toggleLog(this)">
                    ${arrowHtml}<span class="time">[${time}]</span><span class="${type}">${summary}</span></div>`;
        if (detailObj) {
            let jsonStr = "";
            try {
                const obj = (typeof detailObj === 'string') ? JSON.parse(detailObj) : detailObj;
                jsonStr = JSON.stringify(obj, null, 2);
            } catch(e) { jsonStr = detailObj; }
            jsonStr = jsonStr.replace(/"(.*?)":/g, '<span style="color:#9cdcfe">"$1"</span>:').replace(/: "(.*?)"/g, ': <span style="color:#ce9178">"$1"</span>').replace(/: (\d+)/g, ': <span style="color:#b5cea8">$1</span>');
            html += `<div class="json-box"><pre style="margin:0">${jsonStr}</pre></div>`;
        }
        entryDiv.innerHTML = html;
        container.appendChild(entryDiv);
        container.scrollTop = container.scrollHeight;
    }

    window.toggleLog = function(element) {
        const entry = element.parentElement;
        if(entry.querySelector('.json-box')) entry.classList.toggle('expanded');
    };

    // --- 1. LOGIN ---
    async function performLogin(e) {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        log("üîê Attempting HTTP Login...", 'c-sys');
        try {
            const response = await fetch(`${API_BASE}/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            if (response.ok) {
                document.getElementById('authStatus').innerHTML = "<span style='color:#28a745'>‚úÖ Logged In</span>";
                document.getElementById('connectBtn').disabled = false;
                log("‚úÖ Login Success (Cookie Saved)", 'c-sys');
            } else { throw new Error(response.status); }
        } catch (err) { log("‚ùå Login Failed: " + err.message, 'c-err'); }
    }

    // --- 2. WEBSOCKET ---
    function connect() {
        log(`üîå Connecting to ${WS_URL}...`, 'c-sys');
        stompClient = new StompJs.Client({ brokerURL: WS_URL, reconnectDelay: 0 });

        stompClient.onConnect = (frame) => {
            log("‚úÖ <b>STOMP CONNECTED</b>", 'c-sys');
            setConnected(true);
            refreshLobby();
            initLocalBoard(); // Initialize ASCII board on connect

            stompClient.subscribe('/user/queue/errors', (msg) => log(`‚ùå ERROR RECEIVED`, 'c-err', msg.body));

            stompClient.subscribe('/user/queue/game/created', (msg) => {
                const body = JSON.parse(msg.body);
                const id = body.gameId || body;
                document.getElementById('gameIdInput').value = id;
                log(`üéâ GAME CREATED: ${id}`, 'c-in', msg.body);
                subscribeToGame(id);
            });

            stompClient.subscribe('/user/queue/game/joined', (msg) => {
                const body = JSON.parse(msg.body);
                document.getElementById('gameIdInput').value = body.gameId;
                log(`ü§ù JOIN CONFIRMED`, 'c-in', msg.body);
                subscribeToGame(body.gameId);
            });
        };

        stompClient.onStompError = (frame) => log("‚ùå BROKER ERROR", 'c-err', frame.headers['message']);
        stompClient.activate();
    }

    function disconnect() {
        if (stompClient) stompClient.deactivate();
        setConnected(false);
        log("üîå Disconnected", 'c-sys');
    }

    // --- 3. GAME ACTIONS ---
    function createGame() {
        if(!stompClient || !stompClient.connected) return;
        const payload = "PVP";
        log(`üì§ SEND CREATE`, 'c-out', payload);
        stompClient.publish({ destination: '/app/game/create', body: JSON.stringify(payload), headers: { 'content-type': 'application/json' } });
    }

    function joinGame(id) {
        log(`üì§ SEND JOIN (${id})`, 'c-out');
        stompClient.publish({ destination: `/app/game/${id}/join` });
    }

    function makeMove() {
        const id = document.getElementById('gameIdInput').value;
        const rawBody = document.getElementById('movePayload').value;
        log(`üöÄ SEND MOVE`, 'c-out', rawBody);
        stompClient.publish({ destination: `/app/game/${id}/move`, body: rawBody, headers: { 'content-type': 'application/json' } });
    }

    function subscribeToGame(id) {
        if (stompClient.subscriptions && Object.keys(stompClient.subscriptions).some(k => k.includes(id))) return;
        log(`üì° Subscribed to game channel`, 'c-sys');
        stompClient.subscribe(`/topic/game/${id}`, (msg) => {
            log(`‚ôüÔ∏è BOARD UPDATE`, 'c-in', msg.body);
            // UPDATE ASCII BOARD HERE
            handleMoveUpdate(msg.body);
        });
    }

    // --- HELPERS ---
    async function refreshLobby() {
        try {
            const res = await fetch(`${API_BASE}/lobby/open`);
            const ids = await res.json();
            const list = document.getElementById('lobbyList');
            list.innerHTML = "";
            ids.forEach(id => {
                list.innerHTML += `<div style="padding:4px; border-bottom:1px solid #333; font-size:11px;">
                        <span>..${id.slice(-8)}</span>
                        <button onclick="joinGame('${id}')" style="font-size:10px; padding:1px 5px; float:right;">Join</button></div>`;
            });
        } catch (e) { log("Lobby fetch error", 'c-err'); }
    }

    function setConnected(connected) {
        document.getElementById('connectBtn').disabled = connected;
        document.getElementById('disconnectBtn').disabled = !connected;
        document.getElementById('createBtn').disabled = !connected;
        document.getElementById('moveBtn').disabled = !connected;
    }
</script>
</body>
</html>