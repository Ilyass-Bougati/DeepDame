<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeepDame Payload Tester</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; height: 100vh; display: flex; align-items: center; justify-content: center; }
        .container { max-width: 1000px; }
        .log-box { height: 350px; overflow-y: scroll; background: #212529; color: #0f0; font-family: monospace; padding: 10px; border-radius: 5px; font-size: 0.9rem;}
        .status-dot { height: 10px; width: 10px; background-color: #dc3545; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .connected { background-color: #198754; }
        .hidden { display: none !important; }
        .login-container { max-width: 400px; margin: auto; }
    </style>
</head>
<body>

<div class="container">

    <div id="loginSection" class="login-container">
        <div class="card shadow">
            <div class="card-header bg-dark text-white text-center">
                <h4>DeepDame Login</h4>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input type="text" id="username" class="form-control" placeholder="user" value="user">
                </div>
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input type="password" id="password" class="form-control" placeholder="password" value="password">
                </div>
                <button onclick="performLogin()" class="btn btn-primary w-100">Sign In</button>
                <div id="loginError" class="text-danger mt-2 text-center hidden">Login Failed</div>
            </div>
        </div>
    </div>

    <div id="wsSection" class="hidden">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>DeepDame Invite Tester</h2>
            <button class="btn btn-sm btn-outline-secondary" onclick="logout()">Log Out</button>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">1. Connect (Me)</div>
                    <div class="card-body">
                        <div class="mb-2">
                            <label class="form-label">My User ID (For Subscribing)</label>
                            <input type="text" id="myUserId" class="form-control" placeholder="Your UUID">
                        </div>
                        <button id="connectBtn" class="btn btn-primary w-100" onclick="connect()">Connect WS</button>
                        <button id="disconnectBtn" class="btn btn-danger w-100 mt-2 hidden" onclick="disconnect()">Disconnect</button>
                        <div class="mt-3">
                            Status: <span id="statusDot" class="status-dot"></span> <span id="statusText">Disconnected</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card mb-3">
                    <div class="card-header bg-success text-white">2. Send Invitation</div>
                    <div class="card-body">
                        <div class="alert alert-secondary py-2">
                            <small>Sends to: <strong>/app/invite/game</strong> with JSON Body</small>
                        </div>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <label class="form-label">Target User ID</label>
                                <input type="text" id="targetUserId" class="form-control" placeholder="Who receives this?">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Game ID</label>
                                <input type="text" id="gameIdInput" class="form-control" value="game-101">
                            </div>
                        </div>
                        <div class="mt-3">
                            <button id="sendBtn" class="btn btn-outline-success w-100" onclick="sendInvite()" disabled>
                                Send Invite
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">Logs</div>
                    <div class="card-body p-0">
                        <div id="log" class="log-box"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<script>
    // --- LOGIN ---
    async function performLogin() {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        const errorDiv = document.getElementById('loginError');

        try {
            const response = await fetch('/api/v1/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: u,
                    password: p
                })
            });

            if (response.url.includes('error') || response.status === 401) {
                errorDiv.classList.remove('hidden');
            } else {
                errorDiv.classList.add('hidden');
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('wsSection').classList.remove('hidden');
                document.body.style.display = 'block';
                document.body.style.paddingTop = '20px';
            }
        } catch (e) {
            console.error(e);
            errorDiv.textContent = "Network Error";
            errorDiv.classList.remove('hidden');
        }
    }

    function logout() { window.location.reload(); }

    // --- WEBSOCKET ---
    let stompClient = null;

    function log(msg, type = 'info') {
        const logBox = document.getElementById('log');
        const entry = document.createElement('div');

        let prefix = '> ';
        let color = '#ccc';

        if (type === 'rx') { prefix = '⬇ [RECEIVED]: '; color = '#00ffcc'; }
        else if (type === 'tx') { prefix = '⬆ [SENT]: '; color = '#ffcc00'; }
        else if (type === 'err') { prefix = '✖ [ERROR]: '; color = '#ff4444'; }

        entry.style.color = color;
        entry.textContent = prefix + msg;
        logBox.appendChild(entry);
        logBox.scrollTop = logBox.scrollHeight;
    }

    function setConnected(connected) {
        document.getElementById('connectBtn').classList.toggle('hidden', connected);
        document.getElementById('disconnectBtn').classList.toggle('hidden', !connected);
        document.getElementById('sendBtn').disabled = !connected;
        document.getElementById('statusDot').classList.toggle('connected', connected);
        document.getElementById('statusText').innerText = connected ? 'Connected' : 'Disconnected';
        document.getElementById('myUserId').disabled = connected;
    }

    function connect() {
        const myUserId = document.getElementById('myUserId').value;
        if (!myUserId) { alert("Enter your UUID first!"); return; }

        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.debug = null;

        log("Connecting...");

        stompClient.connect({}, function (frame) {
            setConnected(true);
            log('Connected via Cookie Session.');

            // Listen for notifications
            const topic = `/topic/user/${myUserId}/game-notifications`;
            log(`Subscribing to: ${topic}`);

            stompClient.subscribe(topic, function (message) {
                log(message.body, 'rx');
            });

        }, function (error) {
            log(error, 'err');
            setConnected(false);
        });
    }

    function disconnect() {
        if (stompClient !== null) stompClient.disconnect();
        setConnected(false);
        log("Disconnected.");
    }

    function sendInvite() {
        const targetId = document.getElementById('targetUserId').value;
        const gameId = document.getElementById('gameIdInput').value;

        if (!targetId) { alert("Need a target user!"); return; }

        // === THIS IS THE CHANGE ===
        // Destination is static, IDs go into the body
        const destination = `/app/invite/game`;

        const payload = {
            userId: targetId,  // Maps to NotificationRequestDto.userId
            gameId: gameId     // Maps to NotificationRequestDto.gameId
        };

        log(`Sending payload to ${destination}...`, 'tx');
        log(JSON.stringify(payload), 'tx'); // Log the body so you can see it

        stompClient.send(destination, {}, JSON.stringify(payload));
    }
</script>
</body>
</html>